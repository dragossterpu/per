<ui:composition template="../layouts/layoutInterior.xhtml" xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:p="http://primefaces.org/ui">
    <ui:define name="content">
        
        <ui:param name="esJefeInspecciones" value="#{p:ifAnyGranted('JEFE_INSPECCIONES,ADMIN')}" />
        <ui:param name="esJefeEquipoInspeccion" value="#{request.remoteUser eq informeBean.informe.inspeccion.equipo.jefeEquipo.username}" />
                            
        <ui:param name="titulo" value="Redactar informe" />
        <f:event listener="#{navegacionBean.adelante(titulo, request.servletPath)}" type="preRenderView"/>
        <h3>#{titulo}</h3>
            
        <h:form id="informe">

			<p:accordionPanel value="#{informeBean.listaAreas}" var="area" activeIndex="-1" multiple="true">
				<p:tab title="#{area.descripcion}">
					<p:accordionPanel value="#{informeBean.mapaAreasSubareas[area]}" var="subarea" activeIndex="-1" multiple="true" id="tabsubarea">
                        <p:tab>
                            <f:facet name="title">
                                #{subarea.descripcion} 
                                <h:outputText style="color:red" value="#{('(Asignado a: ').concat(informeBean.mapaAsignaciones[subarea]).concat(')')}" rendered="#{not empty informeBean.mapaAsignaciones[subarea]}"/>
                            </f:facet>
                        
                            <p:outputPanel rendered="#{informeBean.mapaAsignaciones[subarea] ne request.remoteUser}">
                                <h:outputText value="#{informeBean.mapaRespuestas[subarea][0]}" escape="false"/>
                                <h:outputFormat rendered="#{not empty informeBean.mapaRespuestas[subarea][1]}">
                                    <h5><h:outputText value="Conclusiones y propuestas."/></h5>
                                    <h:outputText value="#{informeBean.mapaRespuestas[subarea][1]}" escape="false"/>
                                </h:outputFormat>
                            </p:outputPanel>
                            
                            <p:commandButton value="Editar" icon="fa fa-plus-square" actionListener="#{informeBean.asignarSubarea(subarea)}" update="tabsubarea" immediate="true" partialSubmit="true"  rendered="#{empty informeBean.mapaAsignaciones[subarea]}"/>
                            <p:commandButton value="Liberar" icon="fa fa-minus-square" actionListener="#{informeBean.desasignarSubarea(subarea)}" update="tabsubarea" immediate="true" partialSubmit="true" rendered="#{(informeBean.mapaAsignaciones[subarea] eq request.remoteUser) or (not empty informeBean.mapaAsignaciones[subarea] and (esJefeEquipoInspeccion or esJefeInspecciones))}">
                                <p:confirm header="Liberar asignación de subárea" icon="fa fa-exclamation-triangle" message="¿Está seguro de que desea liberarla?, ésto afectará a otro usuario" disabled="#{informeBean.mapaAsignaciones[subarea] eq request.remoteUser}"/>
                            </p:commandButton>
                            
                          <p:outputPanel rendered="#{informeBean.mapaAsignaciones[subarea] eq request.remoteUser}" id="panelRespuestas">
                                <p:textEditor id="editortexto" value="#{informeBean.mapaRespuestas[subarea][0]}" height="300" style="margin-bottom:10px"
                                    required="#{param['informe:finalizar']!=null}" requiredMessage="No puede dejar un subárea sin responder">
                                    
                                    <ui:include src="toolbarEditor.xhtml"/>
                                    
                                </p:textEditor>
                                <p:messages for="editortexto" autoUpdate="true" closable="true" />
                                
                                <h5><h:outputText value="Conclusiones y propuestas."/></h5>
                                <p:textEditor id="editorconclusiones" value="#{informeBean.mapaRespuestas[subarea][1]}" height="300" style="margin-bottom:10px">
                                    
                                    <ui:include src="toolbarEditor.xhtml"/>
                                    
                                </p:textEditor>
                                <p:messages for="editorconclusiones" autoUpdate="true" closable="true" />
                           </p:outputPanel>
                            
                        </p:tab>
					</p:accordionPanel>
				</p:tab>
			</p:accordionPanel>
            
            <div class="botonesFormulario">
                <p:commandButton value="Guardar" actionListener="#{informeBean.guardarInforme}" icon="fa fa-save"  update="informe"/>
                <p:commandButton value="Guardar y liberar mis asignaciones" actionListener="#{informeBean.desasignarInforme}" icon="fa fa-save" update="informe"/>
                <p:commandButton value="Finalizar" id="finalizar" action="#{informeBean.finalizarInforme}" icon="fa fa-check" rendered="#{esJefeInspecciones or esJefeEquipoInspeccion}" />
                <p:button value="Volver" icon="fa fa-fw fa-undo" outcome="/informes/informes" />
            </div>
            
            <h:outputLabel value="Debe cumplimentar todas las subáreas del informe para poder finalizarlo" 
                rendered="#{facesContext.validationFailed}"
                styleClass="ui-widget ui-messages-error ui-corner-all ui-messages-error-summary"/>
                
            <p:dialog id="dialog" widgetVar="dialogMessage" header="INFO" closable="false">
                <p:messages for="dialogMessage" autoUpdate="true" showDetail="true" showSummary="true" />
                <div class="centrarBotonesDialog">
                    <p:button value="Cerrar" onclick="PF('dialogMessage').hide()" />
                </div>
            </p:dialog>
            
            <p:dialog id="dialogFinalizar" widgetVar="dialogFinalizar" header="INFO" closable="false">
                <p:messages for="dialogFinalizar" autoUpdate="true" showDetail="true" showSummary="true" />
                <div class="centrarBotonesDialog">
                    <p:button value="Cerrar" outcome="/informes/informes" />
                </div>
            </p:dialog>
            
            <p:confirmDialog global="true">
                <div class="centrarBotonesDialog">
                    <p:commandButton value="Aceptar" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="Cancelar" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </div>
            </p:confirmDialog>
        </h:form>

    </ui:define>
</ui:composition>
