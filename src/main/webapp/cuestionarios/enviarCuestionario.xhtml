<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<f:view>
	<ui:composition template="../layouts/layoutInterior.xhtml">
		<ui:define name="content">
		
			<ui:param name="esJefeEquipoInspeccion" value="#{request.remoteUser eq envioCuestionarioBean.cuestionarioEnvio.inspeccion.equipo.jefeEquipo or p:ifAnyGranted('JEFE_INSPECCIONES,ADMIN')}"/>
			<ui:param name="yaEnviado" value="#{not empty envioCuestionarioBean.cuestionarioEnvio.fechaEnvio}"/>
			<ui:param name="menuOrigen" value="#{yaEnviado ? '/cuestionarios/busquedaCuestionarios' : '/cuestionarios/busquedaModelosCuestionarios'}"/>
			<ui:param name="yaFinalizado" value="#{not empty envioCuestionarioBean.cuestionarioEnvio.fechaFinalizacion}"/>
            <ui:param name="yaAnulado" value="#{not empty envioCuestionarioBean.cuestionarioEnvio.fechaAnulacion}"/>

			<h3>
				<h:outputText rendered="#{empty envioCuestionarioBean.cuestionarioEnvio.fechaEnvio}" value="Envío cuestionario"/>				
				<h:outputText rendered="#{not empty envioCuestionarioBean.cuestionarioEnvio.fechaEnvio}" value="Modificar datos envío cuestionario"/>
			</h3>
			
			<div class="aclaraciones">
				Los campos marcados con (*) son obligatorios
			</div>

			<h:form id="envioCuestionario" >
		
				<div class="bloqueFormulario">
					<h:outputLabel for="infoInspeccion" value="Nombre Unidad - Número Inspección (*):" />
					<p:autoComplete id="infoInspeccion" value="#{envioCuestionarioBean.cuestionarioEnvio.inspeccion}" completeMethod="#{envioCuestionarioBean.autocompletarInspeccion}"
                        var="inspeccion" itemLabel="#{inspeccion.nombreUnidad} - #{inspeccion.numero}" itemValue="#{inspeccion}" converter="#{selectConverter}" forceSelection="true" 
                        required="true" requiredMessage="Introduzca la unidad o el número de la inspección" 
                        emptyMessage="No se encuentraron resultados coincidentes"
                        onfocus="if (this.value == ' - '){this.value = '';}" queryDelay="1000"
                        disabled="#{yaEnviado}">
                        <p:ajax event="itemSelect" listener="#{envioCuestionarioBean.completarDatosSolicitudPrevia}" update="envioCuestionario"/>
                    </p:autoComplete>
					<p:messages for="infoInspeccion" autoUpdate="true"  closable="true"/>
					
					<h:outputLabel for="nombre" value="Nombre (*):" />
					<p:inputText id="nombre" value="#{envioCuestionarioBean.cuestionarioEnvio.nombreUsuarioEnvio}" maxlength="500"
						required="true" requiredMessage="Introduzca el nombre de la persona a la que va dirigido el cuestionario"
						converter="#{trimConverter}"
                        disabled="#{yaEnviado}"/>
					<p:messages for="nombre" autoUpdate="true"  closable="true"/>
					
					<h:outputLabel for="cargo" value="Cargo:" />
					<p:inputText id="cargo" value="#{envioCuestionarioBean.cuestionarioEnvio.cargo}" maxlength="500" converter="#{trimConverter}"
						disabled="#{yaEnviado}"/>
					
					<h:outputLabel for="correo" value="Correo electrónico (*):" />
					<p:inputText id="correo" value="#{envioCuestionarioBean.cuestionarioEnvio.correoEnvio}" maxlength="500"
						required="true" requiredMessage="Introduzca el correo electrónico" converter="#{trimConverter}"
						validatorMessage="El formato del correo no es correcto o el dominio introducido no es válido"
                        disabled="#{yaEnviado}">
							<f:validateRegex pattern="(?i)^[_a-z0-9-\+]+(\.[_a-z0-9-]+)*@(#{applicationBean.dominiosValidos})$" />
					</p:inputText>
					<p:messages for="correo" autoUpdate="true"  closable="true"/>
					
					<h:outputLabel for="fechaLimite" value="Fecha límite de respuesta (*):" />
					<p:calendar id="fechaLimite"
						value="#{envioCuestionarioBean.cuestionarioEnvio.fechaLimiteCuestionario}"
						pattern="dd/MM/yyyy" locale="es"
						mindate="#{utilities.getCurrentDate()}"
						navigator="true" required="true"
						requiredMessage="Es obligatorio una fecha limite de cumplimentación del cuestionario"
						disabled="#{yaAnulado or yaFinalizado or (yaEnviado and not esJefeEquipoInspeccion)}"/>
					
					<h:outputLabel for="motivo" value="Motivo del cuestionario (*):" />
					<p:inputTextarea id="motivo" value="#{envioCuestionarioBean.cuestionarioEnvio.motivoCuestionario}" maxlength="2000"
						counter="contador" counterTemplate="Quedan {0} caracteres."
						required="true" requiredMessage="Introduzca el motivo de envío del cuestionario" converter="#{trimConverter}"
                        disabled="#{yaEnviado}"/>
					<p:outputLabel id="contador"/>
					<p:messages for="motivo" autoUpdate="true"  closable="true"/>
					
					<p:messages for="mensajeerror" autoUpdate="true" showDetail="true" showSummary="true"/>
				</div>
			
				<div class="botonesFormulario">
					<p:commandButton id="btnEnviar" actionListener="#{envioCuestionarioBean.enviarCuestionario}" value="Enviar" icon="fa fa-fw fa-envelope-o" rendered="#{not yaEnviado and esJefeEquipoInspeccion}" ajax="true" onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()"/>
					<p:commandButton id="btnGuardar" actionListener="#{cuestionarioEnviadoBean.modificarCuestionario}" value="Guardar" icon="fa fa-fw fa-save" rendered="#{yaEnviado and not yaFinalizado and not yaAnulado and esJefeEquipoInspeccion}"/>
					<p:button outcome="#{menuOrigen}" value="Cancelar" icon="fa fa-fw fa-undo"/>
				</div>
				
				<p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
				    <p:graphicImage value="/images/loading.gif" />
				</p:dialog>
				
				<p:dialog id="dialog" widgetVar="dialogMessage" header="INFO" closable="false">
					<p:messages for="dialogMessage" autoUpdate="true" showDetail="true" showSummary="true"/>
					<div class="centrarBotonesDialog">
						<p:button value="Cerrar" outcome="#{menuOrigen}" />
					</div>
				</p:dialog>
				
			</h:form>
			
		</ui:define>
	</ui:composition>
</f:view>
</html>
